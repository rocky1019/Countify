<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Countify ‚Äì Pastel Reimagined</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #7c3aed;
      --primary-fade: #c4b5fd;
      --accent: #10b981;
      --bg1: #ece9ff;
      --bg2: #fdf6ff;
      --bg-glass: rgba(255,255,255,0.78);
      --card: rgba(255,255,255,0.85);
      --text: #21223a;
      --muted: #787e99;
      --shadow: 0 12px 36px -6px rgba(124,58,237,0.11);
    }
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;  
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(120deg, var(--bg1) 55%, var(--bg2));
      color: var(--text);
      min-height: 100vh;
      letter-spacing: 0.01em;
    }
    body { display: flex; flex-direction: column; min-height: 100vh; }
    .page { flex: 1; padding: 16px 6px 96px; display: none; overflow-y: auto; }
    .page.active { display: block; animation: fadeIn 0.38s both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity:1; transform:none;}}

    .top-score {
      position: fixed; top: 18px; right: 22px;
      padding: 8px 20px; background: var(--card);
      border-radius: 16px; font-weight: bold; font-size: 15px;
      box-shadow: var(--shadow); color: var(--primary);
      z-index: 10;
    }

    .navbar {
      position: fixed; top: 0; left: 0; width: 100%; height: 60px;
      background: var(--card); backdrop-filter: blur(12px);
      border-bottom: 1px solid #ddd;
      display: flex; justify-content: space-around; align-items: center;
      z-index: 18; box-shadow: 0 2px 14px -9px var(--primary-fade);
      gap: 0.5em;
    }

    .input-box {
      position: fixed; bottom: 0; left: 0; width: 100%; z-index: 5;
      display: flex; justify-content: center; align-items: center;
      padding: 12px 10px;
      background: var(--bg-glass); backdrop-filter: blur(10px);
      border-top: 1px solid #e7e7ee;
      box-shadow: 0 -3px 16px -7px var(--primary-fade);
      gap: 9px;
    }

    .chat-box {
      position: absolute; top: 60px; bottom: 60px; left: 0; right: 0;
      display: flex; flex-direction: column; gap: 17px;
      padding: 12px; max-width: 520px; margin: 0 auto;
      overflow-y: auto; scroll-behavior: smooth;
    }

    .msg { display: flex; gap: 14px; align-items: flex-start; }
    .avatar {
      width: 38px; height: 38px; border-radius: 50%; flex-shrink:0;
      background: var(--primary);
      display: flex; justify-content: center; align-items: center;
      font-weight: 600; color: #fff; font-size: 1.3em;
      box-shadow: 0 3px 14px -4px var(--primary-fade);
      border: 2px solid #fff; user-select: none;
    }
    .bubble {
      background: var(--card); padding: 12px 18px;
      border-radius: 16px 20px 20px 20px;
      font-size: 16.5px; position: relative;
      box-shadow: 0 2px 8px rgba(124,58,237,0.06);
      min-width: 48px; transition: box-shadow 0.2s;
    }
    .meta { font-size: 12px; color: var(--muted); margin-bottom: 2.5px; }
    .reaction { font-size: 19px; position: absolute; bottom: -18px; left: 13px;
      opacity: 0; transform: scale(0.5);
      transition: all 0.35s cubic-bezier(.33,1.31,.64,.91);
    }
    .reaction.show { opacity: 1; transform: scale(1) rotate(-12deg); }
    .ruin {
      text-align: center; color: #ef4444; font-weight: bold;
      background: #fee2e2; padding: 8px; border-radius: 9px;
      width: 91%; margin: 6px auto 0;
      box-shadow: 0 2px 8px rgba(243,72,72,0.08);
      animation: shake 0.34s;
    }
    @keyframes shake { 0%,100%{transform:translateX(0);}20%{transform:translateX(-5px);}50%{transform:translateX(6px);}75%{transform:translateX(-4px);} }

    input[type="number"] {
      flex: 1; max-width: 180px; padding: 11px 16px;
      font-size: 17px; border: none; border-radius: 10px;
      background: #fdfeff; color: var(--text);
      outline: 2px solid transparent; transition: outline 0.2s;
    }
    input[type="number"]:focus { outline: 2px solid var(--primary); background: #f3f0ff; }

    button {
      padding: 11px 22px; border: none; border-radius: 10px;
      background: linear-gradient(120deg, var(--primary) 65%, var(--accent));
      color: #fff; font-weight: bold; font-size: 15px;
      cursor: pointer; box-shadow: 0 2px 8px rgba(124,58,237,0.10);
      transition: background .18s, transform .16s;
    }
    button:active { transform: scale(0.96); background: var(--primary); }

    .nav-btn i { font-size: 24px; color: var(--muted); transition: color 0.2s; }
    .nav-btn.active i { color: var(--primary); text-shadow: 0 0 6px var(--primary-fade); }
  </style>
</head>
<body>
  <div class="top-score" id="topScore">üèÜ Top: 0</div>

  <div id="counting" class="page active">
    <div class="chat-box" id="chat"></div>
    <div id="typing" class="typing" style="display:none;">Someone is typing 
      <div class="dots"><div></div><div></div><div></div></div>
    </div>
    <div class="input-box">
      <input type="number" id="numberInput" placeholder="Type next number...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <div id="leaderboard" class="page leaderboard">
    <h2>üèÜ Leaderboard</h2>
    <div id="leaderboardList"></div>
  </div>

  <div id="profile" class="page profile">
    <div class="avatar" id="profileAvatar">U</div>
    <h2 id="profileName">Guest</h2>
    <div class="stats">Total Counts: <span id="countStat">0</span></div>
    <button onclick="openModal()">Change Name</button>
  </div>

  <div class="navbar">
    <button class="nav-btn active" data-page="counting"><i class="bi bi-house-fill"></i></button>
    <button class="nav-btn" data-page="leaderboard"><i class="bi bi-trophy-fill"></i></button>
    <button class="nav-btn" data-page="profile"><i class="bi bi-person-fill"></i></button>
  </div>

  <div class="modal" id="modal" style="display:none;">
    <div class="modal-content">
      <h3>Enter Display Name</h3>
      <input type="text" id="nameInput" maxlength="20">
      <button onclick="saveName()">Save</button>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, update, set, increment, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey:"AIzaSyAtPL77AQjetdlPxdGrBvTDzFKijmR0tcI",
    authDomain:"countify-394d8.firebaseapp.com",
    projectId:"countify-394d8",
    storageBucket:"countify-394d8.firebasestorage.app",
    messagingSenderId:"23269864937",
    appId:"1:23269864937:web:f4fc3d43fa6472ff134778"
  };

  const app=initializeApp(firebaseConfig);
  const db=getDatabase(app);
  const auth=getAuth(app);

  const input=document.getElementById("numberInput");
  let uid=null, userName=localStorage.getItem("displayName")||"Guest";
  let topScore=0;

  // auth
  signInAnonymously(auth).then(res=>{
    uid=res.user.uid;
    set(ref(db,"users/"+uid),{displayName:userName,totalCounts:0});
  });

  // Modal
  window.openModal = () => { document.getElementById("modal").style.display="flex"; };
  window.saveName = () => {
    const name=document.getElementById("nameInput").value.trim();
    if(name){
      userName=name;
      localStorage.setItem("displayName",name);
      document.getElementById("profileName").innerText=name;
      document.getElementById("profileAvatar").innerText=name.charAt(0).toUpperCase();
      document.getElementById("modal").style.display="none";
      if(uid) update(ref(db,"users/"+uid),{displayName:name});
    }
  };
  if(!localStorage.getItem("displayName")){ openModal(); }
  else {
    const saved=localStorage.getItem("displayName");
    userName=saved;
    document.getElementById("profileName").innerText=saved;
    document.getElementById("profileAvatar").innerText=saved.charAt(0).toUpperCase();
  }

  const chat=document.getElementById("chat");
  const rendered=new Set();

  onValue(ref(db,"countingRoom/messages"), snap=>{
    snap.forEach(c=>{
      const key=c.key;
      if(!rendered.has(key)){ renderMsg(c.val()); rendered.add(key); }
    });
    chat.scrollTop=chat.scrollHeight;
  });

  onValue(ref(db,"countingRoom/topScore"),s=>{
    topScore=s.val()||0;
    document.getElementById("topScore").innerText="üèÜ Top: "+topScore;
  });

  onValue(ref(db,"users"),snap=>{
    const list=document.getElementById("leaderboardList"); list.innerHTML="";
    const arr=[]; snap.forEach(c=>arr.push(c.val()));
    arr.sort((a,b)=>b.totalCounts-a.totalCounts);
    arr.forEach(u=>{
      const card=document.createElement("div"); card.className="card";
      card.innerHTML=`<span>${u.displayName}</span><span>${u.totalCounts}</span>`;
      list.appendChild(card);
    });
  });

  function sendMsg(){
    const val=parseInt(input.value);
    if(isNaN(val)) return;
    const time=new Date().toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});

    runTransaction(ref(db,"countingRoom"), room=>{
      if(!room) room={current:0,topScore:0,lastUser:null};
      const expected=room.current+1;
      if(val===expected && room.lastUser!==uid){
        room.current=val;
        room.topScore=Math.max(val,room.topScore||0);
        room.lastUser=uid;
        room._status="correct";
      } else {
        room.current=0;
        room.lastUser=null;
        room._status="ruin";
      }
      return room;
    }).then(result=>{
      if(result.committed){
        const status=result.snapshot.val()._status;
        push(ref(db,"countingRoom/messages"),{
          user:userName,number:val,status,time
        });
        if(status==="correct" && uid){
          update(ref(db,"users/"+uid),{displayName:userName,totalCounts:increment(1)});
        }
        update(ref(db,"countingRoom"),{_status:null});
      }
    });

    input.value="";
  }

  function renderMsg(msg){
    const div=document.createElement("div");
    div.className="msg";
    div.innerHTML=`<div class="avatar">${msg.user.charAt(0).toUpperCase()}</div>
      <div><div class="meta">${msg.user} ‚Ä¢ ${msg.time}</div>
      <div class="bubble">${msg.number}<span class="reaction">${msg.status==="correct"?"‚úÖ":"‚ùå"}</span></div></div>`;
    chat.appendChild(div);
    setTimeout(()=>div.querySelector(".reaction").classList.add("show"),120);
    if(msg.status==="ruin"){
      const ruin=document.createElement("div"); ruin.className="ruin";
      ruin.innerText=`üö® ${msg.user} RUINED at ${msg.number}! Reset to 1.`; 
      chat.appendChild(ruin);
    }
  }

  // Typing indicator
  input.addEventListener("input",()=>{
    if(uid) set(ref(db,"countingRoom/typing/"+uid),userName);
    setTimeout(()=>{ if(uid) set(ref(db,"countingRoom/typing/"+uid),null); },800);
  });
  onValue(ref(db,"countingRoom/typing"),snap=>{
    const typing=document.getElementById("typing");
    typing.style.display=snap.exists()?"flex":"none";
  });

  document.getElementById("sendBtn").addEventListener("click",sendMsg);
  input.addEventListener("keyup",e=>{if(e.key==="Enter") sendMsg();});
  document.querySelectorAll(".nav-btn").forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.page).classList.add("active");
    }
  });
</script>
</body>
</html>

